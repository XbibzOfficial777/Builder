name: Environment Setup

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to setup'
        required: true
        default: 'production'
        type: choice
        options:
          - staging
          - production
      api_url:
        description: 'API Base URL'
        required: false
        default: 'https://api.terabox-downloader.example.com'
      rate_limit:
        description: 'Rate Limit (requests per 15 min)'
        required: false
        default: '100'
      max_file_size:
        description: 'Max File Size (bytes)'
        required: false
        default: '1073741824'

env:
  NODE_ENV: ${{ github.event.inputs.environment }}

jobs:
  setup:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Setup environment variables
        run: |
          echo "=========================================="
          echo "üîß SETTING UP ${{ github.event.inputs.environment }} ENVIRONMENT"
          echo "=========================================="
          echo ""
          
          ENVIRONMENT="${{ github.event.inputs.environment }}"
          API_URL="${{ github.event.inputs.api_url }}"
          RATE_LIMIT="${{ github.event.inputs.rate_limit }}"
          MAX_FILE_SIZE="${{ github.event.inputs.max_file_size }}"
          
          echo "Environment: $ENVIRONMENT"
          echo "API URL: $API_URL"
          echo "Rate Limit: $RATE_LIMIT"
          echo "Max File Size: $MAX_FILE_SIZE"
          echo ""
          
          # Create backend .env file
          mkdir -p backend
          cat << EOF > backend/.env
          # Auto-generated on $(date)
          NODE_ENV=$ENVIRONMENT
          PORT=3000
          FRONTEND_URL=https://terabox-downloader.netlify.app
          RATE_LIMIT=$RATE_LIMIT
          MAX_FILE_SIZE=$MAX_FILE_SIZE
          API_BASE_URL=$API_URL
          EOF
          
          echo "‚úÖ Backend .env file created"
          cat backend/.env
          echo ""
          
          # Create frontend .env file
          cat << EOF > .env
          # Auto-generated on $(date)
          VITE_API_URL=$API_URL
          EOF
          
          echo "‚úÖ Frontend .env file created"
          cat .env
          echo ""
          
          # Create environment summary
          cat << EOF > environment-summary.md
          # Environment Setup Summary
          
          ## Configuration
          - **Environment**: $ENVIRONMENT
          - **API URL**: $API_URL
          - **Rate Limit**: $RATE_LIMIT requests per 15 minutes
          - **Max File Size**: $MAX_FILE_SIZE bytes ($(echo "$MAX_FILE_SIZE / 1024 / 1024 / 1024" | bc) GB)
          - **Setup Date**: $(date)
          
          ## Files Created
          - backend/.env
          - .env (frontend)
          
          ## Next Steps
          1. Verify environment variables
          2. Run tests
          3. Deploy to $ENVIRONMENT
          EOF
          
          echo "=========================================="
          echo "‚úÖ ENVIRONMENT SETUP COMPLETE"
          echo "=========================================="
      
      - name: Install dependencies
        run: |
          echo "Installing frontend dependencies..."
          npm ci
          
          echo "Installing backend dependencies..."
          cd backend
          npm ci
          cd ..
      
      - name: Validate configuration
        run: |
          echo "=========================================="
          echo "üîç VALIDATING CONFIGURATION"
          echo "=========================================="
          echo ""
          
          cd backend
          
          # Load environment variables
          set -a
          source .env
          set +a
          
          # Run validation
          node src/config/validate.js || true
          
          cd ..
          
          echo ""
          echo "=========================================="
          echo "‚úÖ CONFIGURATION VALIDATION COMPLETE"
          echo "=========================================="
      
      - name: Run smoke tests
        run: |
          echo "=========================================="
          echo "üß™ RUNNING SMOKE TESTS"
          echo "=========================================="
          echo ""
          
          cd backend
          
          # Load environment variables
          set -a
          source .env
          set +a
          
          # Start server in background
          timeout 10s npm start &
          SERVER_PID=$!
          
          # Wait for server to start
          sleep 3
          
          # Test health endpoint
          echo "Testing health endpoint..."
          if curl -sf http://localhost:3000/api/health; then
            echo "‚úÖ Health check passed"
          else
            echo "‚ö†Ô∏è Health check failed"
          fi
          
          # Kill server
          kill $SERVER_PID 2>/dev/null || true
          
          cd ..
          
          echo ""
          echo "=========================================="
          echo "‚úÖ SMOKE TESTS COMPLETE"
          echo "=========================================="
        continue-on-error: true
      
      - name: Upload environment files
        uses: actions/upload-artifact@v4
        with:
          name: environment-files-${{ github.event.inputs.environment }}
          path: |
            backend/.env
            .env
            environment-summary.md
          retention-days: 30
      
      - name: Send notification
        uses: 8398a7/action-slack@v3
        if: always()
        with:
          status: ${{ job.status }}
          channel: '#deployments'
          text: |
            ${{ job.status == 'success' && '‚úÖ' || '‚ùå' }} Environment Setup ${{ job.status }}
            
            **Environment**: ${{ github.event.inputs.environment }}
            **API URL**: ${{ github.event.inputs.api_url }}
            **Rate Limit**: ${{ github.event.inputs.rate_limit }}
            
            üîó Workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        continue-on-error: true

name: Build WebToApk

on:
  workflow_dispatch:
    inputs:
      website_url:
        description: 'Website URL to convert to APK'
        required: true
        type: string
      app_name:
        description: 'Application Name'
        required: true
        type: string
        default: 'WebApp'
      package_name:
        description: 'Package Name (e.g., com.example.app)'
        required: true
        type: string
        default: 'com.webtoapk.app'
      app_version:
        description: 'App Version (e.g., 1.0.0)'
        required: true
        type: string
        default: '1.0.0'
      version_code:
        description: 'Version Code (integer)'
        required: true
        type: string
        default: '1'
      icon_url:
        description: 'Icon URL (optional)'
        required: false
        type: string

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Download and setup Android Command Line Tools
        run: |
          mkdir -p $HOME/android-sdk/cmdline-tools
          cd $HOME/android-sdk/cmdline-tools
          wget -q https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip
          unzip -q commandlinetools-linux-11076708_latest.zip
          mv cmdline-tools latest
          rm commandlinetools-linux-11076708_latest.zip

      - name: Set environment variables
        run: |
          echo "ANDROID_HOME=$HOME/android-sdk" >> $GITHUB_ENV
          echo "ANDROID_SDK_ROOT=$HOME/android-sdk" >> $GITHUB_ENV
          echo "$HOME/android-sdk/cmdline-tools/latest/bin" >> $GITHUB_PATH
          echo "$HOME/android-sdk/platform-tools" >> $GITHUB_PATH

      - name: Accept licenses
        run: |
          yes | sdkmanager --licenses || true

      - name: Install build tools
        run: |
          sdkmanager "build-tools;34.0.0" "platforms;android-34" "platform-tools"

      - name: Create Android project from template
        run: |
          mkdir -p $HOME/android-project
          cp -r $GITHUB_WORKSPACE/android-template/* $HOME/android-project/
          ls -la $HOME/android-project/

      - name: Update project with custom values
        run: |
          cd $HOME/android-project
          
          # Update app name
          sed -i "s/APP_NAME_PLACEHOLDER/${{ github.event.inputs.app_name }}/g" app/src/main/res/values/strings.xml
          
          # Update package name
          OLD_PACKAGE="com.webtoapk.app"
          NEW_PACKAGE="${{ github.event.inputs.package_name }}"
          sed -i "s/$OLD_PACKAGE/$NEW_PACKAGE/g" app/build.gradle
          sed -i "s/$OLD_PACKAGE/$NEW_PACKAGE/g" app/src/main/AndroidManifest.xml
          sed -i "s/$OLD_PACKAGE/$NEW_PACKAGE/g" app/src/main/java/com/webtoapk/app/MainActivity.java
          
          # Update version
          sed -i "s/VERSION_NAME_PLACEHOLDER/${{ github.event.inputs.app_version }}/g" app/build.gradle
          sed -i "s/VERSION_CODE_PLACEHOLDER/${{ github.event.inputs.version_code }}/g" app/build.gradle
          
          # Update website URL
          sed -i "s|WEBSITE_URL_PLACEHOLDER|${{ github.event.inputs.website_url }}|g" app/src/main/java/com/webtoapk/app/MainActivity.java
          
          # Show updated files for debugging
          echo "=== Updated strings.xml ==="
          cat app/src/main/res/values/strings.xml
          echo "=== Updated build.gradle ==="
          cat app/build.gradle

      - name: Download and process icon
        if: github.event.inputs.icon_url != ''
        run: |
          cd $HOME/android-project/app/src/main/res
          
          # Download icon
          curl -L -o icon.png "${{ github.event.inputs.icon_url }}" || echo "Using default icon"
          
          if [ -f icon.png ]; then
            # Create different sizes
            mkdir -p mipmap-mdpi mipmap-hdpi mipmap-xhdpi mipmap-xxhdpi mipmap-xxxhdpi
            
            # Copy icon to all directories
            cp icon.png mipmap-mdpi/ic_launcher.png
            cp icon.png mipmap-hdpi/ic_launcher.png
            cp icon.png mipmap-xhdpi/ic_launcher.png
            cp icon.png mipmap-xxhdpi/ic_launcher.png
            cp icon.png mipmap-xxxhdpi/ic_launcher.png
          fi

      - name: Build APK
        run: |
          cd $HOME/android-project
          chmod +x gradlew
          ./gradlew assembleRelease --stacktrace

      - name: Debug - List build outputs
        run: |
          echo "=== Listing build directory ==="
          ls -la $HOME/android-project/app/build/outputs/apk/release/ 2>/dev/null || echo "Release directory not found"
          
          echo "=== Listing all APK files ==="
          find $HOME/android-project -name "*.apk" -type f 2>/dev/null || echo "No APK files found"

      - name: Sign APK
        run: |
          cd $HOME/android-project
          
          # Find the unsigned APK file
          UNSIGNED_APK=$(find app/build/outputs/apk/release -name "*.apk" -type f | head -1)
          
          if [ -z "$UNSIGNED_APK" ]; then
            echo "Error: No APK file found!"
            exit 1
          fi
          
          echo "Found APK: $UNSIGNED_APK"
          
          # Generate debug keystore
          keytool -genkey -v -keystore debug.keystore -storepass android -alias androiddebugkey -keypass android -keyalg RSA -keysize 2048 -validity 10000 -dname "CN=Android Debug,O=Android,C=US"
          
          # Create safe filename
          SAFE_APP_NAME=$(echo "${{ github.event.inputs.app_name }}" | tr ' ' '_' | tr -cd '[:alnum:]_-')
          OUTPUT_APK="app/build/outputs/apk/release/${SAFE_APP_NAME}-v${{ github.event.inputs.app_version }}.apk"
          
          # Sign the APK
          $ANDROID_HOME/build-tools/34.0.0/apksigner sign --ks debug.keystore --ks-pass pass:android --key-pass pass:android --in "$UNSIGNED_APK" --out "$OUTPUT_APK"
          
          echo "Signed APK created: $OUTPUT_APK"
          ls -la "$OUTPUT_APK"

      - name: Upload APK to GitHub Releases
        uses: softprops/action-gh-release@v1
        if: success()
        with:
          tag_name: ${{ github.event.inputs.app_name }}-v${{ github.event.inputs.app_version }}-${{ github.run_number }}
          name: ${{ github.event.inputs.app_name }} v${{ github.event.inputs.app_version }}
          body: |
            APK generated from website: ${{ github.event.inputs.website_url }}
            
            - App Name: ${{ github.event.inputs.app_name }}
            - Package: ${{ github.event.inputs.package_name }}
            - Version: ${{ github.event.inputs.app_version }}
            - Version Code: ${{ github.event.inputs.version_code }}
          files: |
            /home/runner/android-project/app/build/outputs/apk/release/*.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload APK as artifact
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: ${{ github.event.inputs.app_name }}-v${{ github.event.inputs.app_version }}
          path: /home/runner/android-project/app/build/outputs/apk/release/*.apk
          retention-days: 30

      - name: Upload build logs on failure
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: build-logs
          path: |
            /home/runner/android-project/app/build/outputs/
            /home/runner/android-project/*.log
          retention-days: 7

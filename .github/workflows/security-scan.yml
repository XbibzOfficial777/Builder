name: Security Scan

on:
  schedule:
    - cron: '0 0 * * 0'  # Weekly on Sunday at midnight
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  NODE_ENV: test

jobs:
  # Snyk Security Scan
  snyk-scan:
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install frontend dependencies
        run: npm ci
      
      - name: Install backend dependencies
        working-directory: ./backend
        run: npm ci
      
      - name: Run Snyk Security Scan (Frontend)
        uses: snyk/actions/node@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high --file=package.json
      
      - name: Run Snyk Security Scan (Backend)
        uses: snyk/actions/node@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high --file=backend/package.json
      
      - name: Upload Snyk results
        uses: actions/upload-artifact@v4
        with:
          name: snyk-results
          path: snyk-report.html
        continue-on-error: true

  # Dependency Review
  dependency-review:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Dependency Review
        uses: actions/dependency-review-action@v3
        with:
          fail-on-severity: high
          comment-summary-in-pr: true

  # CodeQL Analysis
  codeql-analysis:
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write
    
    strategy:
      fail-fast: false
      matrix:
        language: ['javascript']
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ matrix.language }}
          queries: security-extended,security-and-quality
      
      - name: Autobuild
        uses: github/codeql-action/autobuild@v3
      
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:${{matrix.language}}"

  # NPM Audit
  npm-audit:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install frontend dependencies
        run: npm ci
      
      - name: Run npm audit (Frontend)
        run: |
          echo "=========================================="
          echo "üîç NPM AUDIT - FRONTEND"
          echo "=========================================="
          npm audit --audit-level=high || true
          echo ""
      
      - name: Install backend dependencies
        working-directory: ./backend
        run: npm ci
      
      - name: Run npm audit (Backend)
        run: |
          echo "=========================================="
          echo "üîç NPM AUDIT - BACKEND"
          echo "=========================================="
          npm audit --audit-level=high || true
          echo ""
      
      - name: Generate security report
        run: |
          cat << 'EOF' > security-report.md
          # Security Scan Report
          
          ## Scan Information
          - **Date**: $(date)
          - **Trigger**: ${{ github.event_name }}
          - **Commit**: ${{ github.sha }}
          
          ## Scans Performed
          1. ‚úÖ Snyk Security Scan
          2. ‚úÖ Dependency Review
          3. ‚úÖ CodeQL Analysis
          4. ‚úÖ NPM Audit
          
          ## Results
          Check the individual scan results above for detailed information.
          
          ## Recommendations
          - Review all high and critical severity issues
          - Update dependencies regularly
          - Enable Dependabot alerts
          - Run security scans before each release
          EOF
          
          cat security-report.md
      
      - name: Upload security report
        uses: actions/upload-artifact@v4
        with:
          name: security-report
          path: security-report.md
          retention-days: 30

  # Secret Scanning
  secret-scan:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Secret Detection
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --debug --only-verified
        continue-on-error: true

  # Security Summary
  security-summary:
    runs-on: ubuntu-latest
    needs: [snyk-scan, dependency-review, codeql-analysis, npm-audit, secret-scan]
    if: always()
    
    steps:
      - name: Generate summary
        run: |
          echo "=========================================="
          echo "üîí SECURITY SCAN SUMMARY"
          echo "=========================================="
          echo ""
          echo "Snyk Scan: ${{ needs.snyk-scan.result }}"
          echo "Dependency Review: ${{ needs.dependency-review.result }}"
          echo "CodeQL Analysis: ${{ needs.codeql-analysis.result }}"
          echo "NPM Audit: ${{ needs.npm-audit.result }}"
          echo "Secret Scan: ${{ needs.secret-scan.result }}"
          echo ""
          
          if [ "${{ needs.snyk-scan.result }}" == "success" ] && \
             [ "${{ needs.codeql-analysis.result }}" == "success" ] && \
             [ "${{ needs.npm-audit.result }}" == "success" ]; then
            echo "‚úÖ All critical security scans passed"
          else
            echo "‚ö†Ô∏è Some security scans need attention"
          fi
          
          echo ""
          echo "=========================================="
      
      - name: Send notification
        uses: 8398a7/action-slack@v3
        if: always()
        with:
          status: ${{ job.status }}
          channel: '#security'
          text: |
            üîí Security Scan Summary
            
            **Snyk Scan**: ${{ needs.snyk-scan.result }}
            **Dependency Review**: ${{ needs.dependency-review.result }}
            **CodeQL Analysis**: ${{ needs.codeql-analysis.result }}
            **NPM Audit**: ${{ needs.npm-audit.result }}
            **Secret Scan**: ${{ needs.secret-scan.result }}
            
            üîó Workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        continue-on-error: true
